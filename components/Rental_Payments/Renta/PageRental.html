<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Renta</title>
  <link rel="stylesheet" href="/components/Rental_Payments/Renta/PageRental.css" />
</head>
<body>
  <div class="PaginaRenta">
    <div id="mainHeaderContainer"></div>

    <main class="contenedor-centro">
      <div class="tarjeta-alquiler">
        <div class="formulario-alquiler">
          <h2>Alquiler de Bicicletas y Patinetas</h2>
          <form id="formularioAlquiler">
            <label for="modelo">Modelo del vehículo:</label>
            <input type="text" id="modelo" readonly />

            <label for="fechaInicio">Fecha y hora de inicio:</label>
            <input type="datetime-local" id="fechaInicio" readonly />

            <label for="estacion">Estación del vehículo:</label>
            <input type="text" id="estacion" readonly />

            <label for="duracion">Duración del alquiler (horas):</label>
            <input type="number" id="duracion" min="1" max="24" required />

            <label for="horaFinal">Hora final estimada:</label>
            <input type="datetime-local" id="horaFinal" readonly />

            <label for="precio">Precio total (Bs):</label>
            <input type="text" id="precio" readonly />

            <label for="metodoPago">Método de pago:</label>
            <div class="selector-pago">
              <input type="radio" name="pago" id="pagoTarjeta" value="Tarjeta" checked>
              <label for="pagoTarjeta" class="opcion-pago">Tarjeta</label>

              <input type="radio" name="pago" id="pagoQR" value="QR">
              <label for="pagoQR" class="opcion-pago">QR</label>
            </div>

            <button type="button" id="confirmarAlquiler">Pagar</button>
          </form>
        </div>

        <div class="detalles-transporte">
          <div class="detalle-card" id="detallesTransporte"></div>
        </div>
      </div>
    </main>

    <div id="mainFooterContainer"></div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetch("../Templates/Header.html")
        .then(res => res.text())
        .then(html => {
          document.getElementById("mainHeaderContainer").innerHTML = html;
          setTimeout(() => {
            const usuario = JSON.parse(localStorage.getItem("usuario"));
            if (usuario) {
              const nombreElemento = document.getElementById("userName");
              const avatarElemento = document.getElementById("userAvatar");
              if (nombreElemento) nombreElemento.textContent = usuario.nombre || "Usuario";
              if (avatarElemento) avatarElemento.src = usuario.imagen || "https://i.ibb.co/FbRJBrW2/imagen-2025-05-29-014716685.png";
            }
          }, 100);
        });

      fetch("../Templates/Footer.html")
        .then(res => res.text())
        .then(html => document.getElementById("mainFooterContainer").innerHTML = html);

      const data = JSON.parse(localStorage.getItem("vehiculoEnAlquiler"));
      const container = document.getElementById("detallesTransporte");

      if (data && container) {
        document.getElementById("modelo").value = data.nombre;
        document.getElementById("estacion").value = data.estacion;
        const ahora = new Date();
        document.getElementById("fechaInicio").value = ahora.toISOString().slice(0, 16);

        let badgeClass = "";
        if (data.estado === "Disponible") badgeClass = "badge-disponible";
        else if (data.estado === "En uso") badgeClass = "badge-en-uso";
        else badgeClass = "badge-mante";

        container.innerHTML = `
          <div class="imagen-container">
            <img src="${data.imagen}" alt="${data.nombre}" />
          </div>
          <h2 class="detalle-nombre">${data.nombre}</h2>
          <span class="${badgeClass}">${data.estado}</span>
          <div class="detalle-info">
            <p><strong>Tarifa:</strong> Bs ${data.tarifa.toFixed(2)}/hora</p>
            <p><strong>Estación:</strong> ${data.estacion}</p>
            <p><strong>Descripción:</strong><br>${data.descripcion}</p>
            <p><strong>Tecnología:</strong></p>
            <ul>${data.tecnologia.map(t => `<li>${t}</li>`).join("")}</ul>
          </div>
        `;

        document.getElementById("duracion").addEventListener("input", () => {
          const horas = parseInt(document.getElementById("duracion").value) || 0;
          const fechaInicio = new Date(document.getElementById("fechaInicio").value);
          const fechaFinal = new Date(fechaInicio.getTime() + horas * 60 * 60 * 1000);
          document.getElementById("horaFinal").value = fechaFinal.toISOString().slice(0, 16);
          document.getElementById("precio").value = (horas * data.tarifa).toFixed(2);
        });

        document.getElementById("confirmarAlquiler").addEventListener("click", () => {
          const horas = parseInt(document.getElementById("duracion").value);
          if (!horas || horas < 1 || horas > 24) {
            alert("Duración inválida. Máximo 24 horas.");
            return;
          }

          const metodoSeleccionado = document.querySelector('input[name="pago"]:checked').value;
          const total = (horas * data.tarifa).toFixed(2);
          const inicio = document.getElementById("fechaInicio").value;
          const fin = document.getElementById("horaFinal").value;

          const datosPago = {
            modelo: data.nombre,
            estacion: data.estacion,
            metodo: metodoSeleccionado,
            horas,
            total,
            inicio,
            fin
          };

          localStorage.setItem("datosPago", JSON.stringify(datosPago));
          window.location.href = "/components/Rental_Payments/Pay/Pago.html";
        });
      }
    });
  </script>
</body>
</html>
